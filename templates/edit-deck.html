{{ define "content" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<span style="grid-area: title">
  <h1><input id="deck-title" type="text" value="{{ getValue .Deck "name" }}" /></h1>
</span>

<span class="flex flex--row" style="grid-area: actions">
  <label id="is-public-button" for="is-public" class="button">
    Display publicly
    <input id="is-public" type="checkbox" {{ if (getValue .Deck "is_public") }} checked {{ end }} />
  </label>
  <button id="select-tile-image">Choose Background Image</button>
  <button id="reselect-spellslinger">Reselect Spellslinger</button>
  <button id="reselect-splash">Reselect Splash</button>
</span>

<ssrr-deck style="grid-area: deck"></ssrr-deck>

<section style="grid-area: description">
  <h2>Description</h2>
  <textarea id="deck-description">{{ getValue .Deck "description" }}</textarea>
</section>

<section style="grid-area: code">
  <h2>Import Code</h2>
  <p>Will be auto-generated!</p>
</section>

<section style="grid-area: charts">
  <h2>Charts</h2>
  <div class="grid" style="--grid-min-width: 200px">
    <ssrr-chart id="ManaCostChart"></ssrr-chart>
    <ssrr-chart id="CardTypeChart"></ssrr-chart>
    <ssrr-chart id="RarityChart"></ssrr-chart>
  </div>
</section>

<ssrr-cardlist style="grid-area: cards"></ssrr-cardlist>

<footer>
  <label>Cards: <span id="current-count">{{ countCards .Deck }}</span>/30</label>
  <button id="save-button" style="--button-colour: var(--colour-success)">Save</button>
  <button id="reset-button" style="--button-colour: var(--colour-warning)">Reset</button>
  <button id="delete-button" style="--button-colour: var(--colour-error)">Delete</button>
</footer>

<dialog id="spellslinger-picker">
  <h2>Choose a Spellslinger</h2>
  <div class="dialog-body">
    {{ range .Spellslingers }}
      {{ $colour := getValue . "colour" }}
      {{ $abilities := getValue . "abilities" }}
      {{ $signatures := getValue . "signatures" }}
    
      <section class="spellslinger-tile grid" style="--grid-min-width: 0">
        <img loading="lazy" class="spellslinger-tile__image" style="grid-area: image" src="/images/spellslingers/{{ getValue . "name" }}.webp" />
        <h3 style="grid-area: name"><a href="/spellslingers/{{ .Id }}">{{ getValue . "name" }}</a></h3>
        <span style="grid-area: health"><label>Health:</label> {{ getValue . "health" }}</span>
        <span style="grid-area: colour">{{ range $colour }}{{ getValue . "name" }} {{ end }}</span>
        <span style="grid-area: ability">
          {{ range $abilities }}
            <p><label>{{ getValue . "name" }}:</label> {{ getValue . "ability" }}</p>
          {{ end }}
        </span>
        <span style="grid-area: button">
          <button data-spellslinger="{{ marshal . }}">Pick This Spellslinger</button>
        </span>
      </section>
    {{ end }}
  </div>
</dialog>

<dialog id="colour-picker">
  <h2>Choose a Splash</h2>
  <div class="dialog-body">
    {{ range .Colours }}
      <button data-colour="{{ marshal . }}">{{ getValue . "name" }}</button>
    {{ end }}
    <button data-colour="">None</button>
  </div>
</dialog>

<dialog id="tile-image-picker">
  <h2>Choose a Background Image</h2>
  <form class="dialog-body"></form>
</dialog>

<script type="module">
  import SsrrCardList from '/js/ssrr-cardlist-edit.js'
  import SsrrDeck from '/js/ssrr-deck.js'
  import SsrrChart from '/js/ssrr-chart.js'
  import { alertModal, confirmModal } from '/js/main.js'
  import Deck from '/js/deck.js'

  const deck = new Deck(
    {{ marshal .Deck }},
    document.querySelector('ssrr-deck'),
    document.querySelector('#ManaCostChart'),
    document.querySelector('#RarityChart'),
    document.querySelector('#CardTypeChart'),
    document.querySelector('#deck-title'),
    document.querySelector('#deck-description'),
    document.querySelector('#is-public'),
    document.querySelector('#current-count'),
  )

  document.querySelector('ssrr-cardlist').addCardCallback = deck.addCard.bind(deck)
  document.querySelector('ssrr-cardlist').removeCardCallback = deck.removeCard.bind(deck)

  document.querySelector('#deck-title').addEventListener('change', (e) => deck.setName(e.target.value))
  document.querySelector('#deck-description').addEventListener('change', (e) => deck.setDescription(e.target.value))
  document.querySelector('#is-public').addEventListener('change', (e) => deck.setIsPublic(e.target.checked))

  document.querySelector('#reset-button').addEventListener('click', () => deck.reset())
  document.querySelector('#save-button').addEventListener('click', () => deck.save())
  document.querySelector('#delete-button').addEventListener('click', () => deck.delete())

  if (!deck.hasSpellslinger()) {
    document.querySelector('#spellslinger-picker').showModal()
  }

  if (!deck.canSetSplash()) {
    document.querySelector('#reselect-splash').hidden = true
  }
  
  document.querySelectorAll('[data-spellslinger]').forEach((button) => {
    button.addEventListener('click', (e) => {
      deck.setSpellslinger(e.target.getAttribute('data-spellslinger'))
      document.querySelector('#spellslinger-picker').close()
      if (deck.canSetSplash()) {
        document.querySelector('#colour-picker').showModal()
        document.querySelector('#reselect-splash').hidden = false
      }
      else {
        document.querySelector('#reselect-splash').hidden = true
      }
    })
  })

  document.querySelector('#reselect-spellslinger').addEventListener('click', (e) => {
    document.querySelector('#spellslinger-picker').showModal()
  })
 
  document.querySelector('#reselect-splash').addEventListener('click', (e) => {
    document.querySelector('#colour-picker').showModal()
  })

  document.querySelector('#select-tile-image').addEventListener('click', (e) => {
    document.querySelector('#tile-image-picker form').innerHTML = deck.getCards().map((card) => {
      return `
        <div class="flex flex--row">
          <input type="radio" name="tile-image" id="tile-image-${card.name}" value="/images/cards/tiles/${card.name}.jpeg" />
          <label class="flex flex--row" for="tile-image-${card.name}">
            ${card.name}
            <img class="tile-thumbnail" alt="" src="/images/cards/tiles/${card.name}.jpeg" />
          </label>
        </div>
      `
    }).join('')
    document.querySelector('#tile-image-picker form').innerHTML += '<button type="submit">Choose</button>'
    document.querySelector('#tile-image-picker').showModal()
  })

  document.querySelector('#tile-image-picker form').addEventListener('submit', (e) => {
    e.preventDefault()

    deck.setImage(e.target.querySelector('[name=tile-image]:checked').value)
    document.querySelector('#tile-image-picker').close()
  })

  document.querySelectorAll('[data-colour]').forEach((button) => {
    button.addEventListener('click', (e) => {
      deck.setSplash(e.target.getAttribute('data-colour'))
      document.querySelector('#colour-picker').close()
    })
  })

  document.querySelector('[data-colour]').addEventListener('click', (e) => {
    deck.setSplash(e.target.getAttribute('data-colour'))
    document.querySelector('#colour-picker').close()
  })
</script>

<style>
  /* TODO: solve grid layout correctly instead of naming a "gap" area */
  main {
    grid-template: "title title"
                   "actions actions"
                   "deck description"
                   "deck code"
                   "deck charts"
                   "deck cards";
    grid-template-columns: auto 1fr;
  }

  ssrr-deck {
    position: sticky;
    top: -20px;
  }

  ssrr-cardlist,
  ssrr-deck {
    margin-bottom: 150px;
  }

  #is-public-button {
    background-color: var(--secondary-colour);
    color: black;
  }

  #is-public {
    margin: 0;
    accent-color: black;
  }

  /* TODO: pick correct size */
  @media(max-width: 800px) {
    main {
      grid-template: "title"
                     "actions"
                     "deck"
                     "description"
                     "code"
                     "charts"
                     "cards";
    }
  }

  .spellslinger-tile {
    grid-template: "image name"
                   "image health"
                   "image colour"
                   "ability ability"
                   "button button";
  }

  /* TODO: pick correct size */
  @media(min-width: 800px) {
    .spellslinger-tile {
      grid-template: "image name health colour"
                     "image ability ability ability"
                     "image button button button";
    }
  }
</style>
{{ end }}
